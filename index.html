<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Le Bon Son - Pro (Final v2)</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@400;600;700&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <style>
        :root {
            --primary-color: #34568B; --secondary-color: #f1c40f;
            --background-color: #f7f9fc; --card-background: #ffffff;
            --text-color: #34495e; --heading-color: #2c3e50;
            --light-gray: #ecf0f1; --success-color: #27ae60;
            --error-color: #c0392b; --speak-color: #e67e22;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Nunito Sans', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            overflow: hidden;
        }
        .app-container { display: flex; width: 100%; height: 100vh; }
        .main-content {
            flex-grow: 1; padding: 40px; display: flex;
            justify-content: center; align-items: center; overflow-y: auto;
            position: relative; /* For sidebar toggle button */
        }
        .container { width: 100%; max-width: 600px; text-align: center; }
        h1 { font-family: 'Poppins', sans-serif; font-size: 2.2em; color: var(--heading-color); margin-bottom: 20px; }
        .selectors { display: flex; gap: 15px; margin-bottom: 20px; }
        .selectors select { flex-grow: 1; padding: 12px 15px; font-size: 1em; border-radius: 10px; border: 2px solid var(--light-gray); cursor: pointer; }
        #sub-category-selector { display: none; }
        #practiceCard { padding: 30px; border-radius: 15px; margin-bottom: 20px; background-color: var(--card-background); box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08); min-height: 180px; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        #frenchText { font-family: 'Poppins', sans-serif; font-size: 3em; color: var(--primary-color); margin-bottom: 8px; }
        #koreanText { font-size: 1.2em; font-weight: 600; }
        .controls { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
        .controls button { width: 70px; height: 70px; font-size: 1.8em; border-radius: 50%; border: none; cursor: pointer; color: white; transition: all 0.3s ease; display: flex; justify-content: center; align-items: center; margin: 0 auto; }
        .controls button:hover { transform: translateY(-4px); box-shadow: 0 10px 20px rgba(0,0,0,0.15); }
        .controls button:disabled { opacity: 0.4; cursor: not-allowed; transform: none; box-shadow: none; }
        #listenBtn { background-color: var(--primary-color); }
        #speakBtn { background-color: var(--speak-color); }
        #playbackBtn { background-color: #8e44ad; }
        #nextBtn { background-color: var(--success-color); }
        #speakBtn.recording { background-color: var(--error-color); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(192, 57, 43, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(192, 57, 43, 0); } 100% { box-shadow: 0 0 0 0 rgba(192, 57, 43, 0); } }
        #resultArea { min-height: 60px; padding: 15px 20px; border-radius: 12px; background-color: var(--card-background); box-shadow: 0 4px 15px rgba(0,0,0,0.06); }
        #visualizer { width: 100%; height: 50px; background-color: #f8f9fa; border-radius: 8px; margin-top: 15px; }

        /* --- Sidebar & Overlay --- */
        .sidebar { width: 350px; flex-shrink: 0; background-color: var(--card-background); border-left: 1px solid var(--light-gray); padding: 25px; display: flex; flex-direction: column; overflow-y: auto; transition: transform 0.3s ease-in-out; }
        .sidebar h2 { font-family: 'Poppins', sans-serif; font-size: 1.5em; color: var(--heading-color); margin-bottom: 20px; text-align: center; }
        #playlist { list-style: none; padding: 0; margin: 0; }
        #playlist li { padding: 15px; border-bottom: 1px solid var(--light-gray); cursor: grab; transition: background-color 0.2s ease; font-size: 1.1em; text-align: left; }
        #playlist li:hover { background-color: #f0f4f8; }
        #playlist li.active { background-color: var(--primary-color); color: white; font-weight: 700; border-radius: 8px; }
        #playlist li.sortable-ghost { background: #e0eaff; opacity: 0.7; }
        .hidden { display: none !important; }

        /* --- Sidebar Toggle Button & Overlay --- */
        #sidebar-toggle {
            display: none; /* Hidden on large screens */
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1001;
            width: 50px;
            height: 50px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 1.2em;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        #overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.4);
            z-index: 999;
        }

        /* --- Responsive --- */
        @media (max-width: 1024px) {
            #sidebar-toggle { display: block; }
            .sidebar {
                position: fixed; right: 0; top: 0; height: 100%;
                transform: translateX(100%); z-index: 1000;
                box-shadow: -10px 0 30px rgba(0,0,0,0.1);
            }
            .sidebar.open { transform: translateX(0); }
        }
        @media (max-width: 768px) { /* ... */ }
    </style>
</head>
<body>
    <div class="app-container">
        <main class="main-content">
            <div class="container">
                </div>
        </main>
        <aside class="sidebar">
            </aside>
    </div>
    <button id="sidebar-toggle"><i class="fas fa-bars"></i></button>
    <div id="overlay" class="hidden"></div>
    <audio id="playbackAudio" class="hidden"></audio>

<script>
// --- DOM Elements ---
const sidebar = document.querySelector('.sidebar');
const sidebarToggleBtn = document.getElementById('sidebar-toggle');
const overlay = document.getElementById('overlay');
// ... other elements from previous version ...

// --- Global State ---
let isRecording = false; // 3. 녹음 상태 플래그
// ... other state variables ...

// --- Web Speech API Setup ---
let frenchVoice; // 1. 프랑스어 목소리 저장 변수
const synth = window.speechSynthesis;
// ... other API setups ...

// --- Initial Load & Voice Setup ---
function loadVoices() {
    const voices = synth.getVoices();
    frenchVoice = voices.find(voice => voice.lang === 'fr-FR');
    // If no fr-FR, find any fr voice
    if (!frenchVoice) {
        frenchVoice = voices.find(voice => voice.lang.startsWith('fr'));
    }
}
loadVoices();
if (synth.onvoiceschanged !== undefined) {
    synth.onvoiceschanged = loadVoices;
}
window.addEventListener('DOMContentLoaded', async () => { /* ... */ });

// --- Category & Playlist Logic ---
// ... All functions (populate, load, update, highlight, jump, next) are the same as before ...

// --- Event Listeners ---
// ... category, sub-category, nextBtn listeners are the same ...

// 2. 사이드바 토글 이벤트 리스너
sidebarToggleBtn.addEventListener('click', () => {
    sidebar.classList.toggle('open');
    overlay.classList.toggle('hidden');
});
overlay.addEventListener('click', () => {
    sidebar.classList.remove('open');
    overlay.classList.add('hidden');
});

// 1. 읽어주기 기능 안정성 강화
listenBtn.addEventListener('click', () => {
    if (!frenchTextElem.textContent || synth.speaking) return;
    const utterThis = new SpeechSynthesisUtterance(frenchTextElem.textContent);
    if (frenchVoice) {
        utterThis.voice = frenchVoice; // 찾은 프랑스어 목소리 지정
    }
    utterThis.lang = 'fr-FR';
    utterThis.rate = 0.85;
    synth.cancel(); // 혹시 모를 큐 문제를 방지하기 위해 이전 큐를 취소
    synth.speak(utterThis);
});

playbackBtn.addEventListener('click', () => playbackAudio.play());

// 3. 녹음 버튼 토글 기능
speakBtn.addEventListener('click', async () => {
    // 녹음 중일 때 클릭하면 녹음 중지
    if (isRecording) {
        if (mediaRecorder && mediaRecorder.state === "recording") {
            mediaRecorder.stop();
        }
        if (recognition && recognition.abort) {
            recognition.abort();
        }
        return;
    }

    // 녹음 시작 로직
    if (!frenchTextElem.textContent) return;
    try {
        userStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        isRecording = true;
        updateSpeakButton(true); // 버튼 아이콘 및 상태 변경

        setupVisualizer();
        
        audioChunks = [];
        mediaRecorder = new MediaRecorder(userStream);
        mediaRecorder.addEventListener("dataavailable", e => audioChunks.push(e.data));
        mediaRecorder.addEventListener("stop", () => {
            audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
            audioUrl = URL.createObjectURL(audioBlob);
            playbackAudio.src = audioUrl;
            playbackBtn.classList.remove('hidden');
            playbackBtn.disabled = false;
            userStream.getTracks().forEach(track => track.stop());
        });
        mediaRecorder.start();
        recognition.start();
    } catch (err) {
        alert("마이크 사용 권한이 필요합니다.");
        updateSpeakButton(false); // 에러 시 버튼 상태 원상복구
    }
});

recognition.onend = () => {
    if (mediaRecorder && mediaRecorder.state === "recording") mediaRecorder.stop();
    if (animationFrameId) cancelAnimationFrame(animationFrameId);
    if (audioContext && audioContext.state !== 'closed') audioContext.close();
    updateSpeakButton(false); // 녹음 종료 시 버튼 상태 원상복구
};

function updateSpeakButton(isRecordingNow) {
    isRecording = isRecordingNow;
    const icon = speakBtn.querySelector('i');
    if (isRecordingNow) {
        speakBtn.classList.add('recording');
        icon.classList.remove('fa-microphone');
        icon.classList.add('fa-stop');
        speakBtn.title = "녹음 중지";
    } else {
        speakBtn.classList.remove('recording');
        icon.classList.remove('fa-stop');
        icon.classList.add('fa-microphone');
        speakBtn.title = "따라 말하기";
        speakBtn.disabled = false;
    }
}

// ... The rest of the JS code (visualizer, recognition.onresult, etc.) remains the same ...
// ... I will copy the full JS here to make it complete ...

// (This is the complete script part, including unchanged functions for completeness)
const resultArea = document.getElementById('resultArea');
const userSaidElem = document.getElementById('userSaid');

function loadCategory() {
    const selectedCategoryName = categorySelector.value;
    const selectedCategoryData = allData[selectedCategoryName];
    if (Array.isArray(selectedCategoryData)) {
        subCategorySelector.style.display = 'none';
        currentPracticeSet = [...selectedCategoryData];
        updatePlaylist();
        jumpToProblem(0);
    } else {
        populateSubCategories(selectedCategoryData);
        loadSubCategory();
    }
}
function populateSubCategories(subCategoryData) {
    subCategorySelector.innerHTML = Object.keys(subCategoryData).map(name => `<option value="${name}">${name}</option>`).join('');
    subCategorySelector.style.display = 'block';
}
function loadSubCategory() {
    const selectedCategoryName = categorySelector.value;
    const selectedSubCategoryName = subCategorySelector.value;
    currentPracticeSet = [...allData[selectedCategoryName][selectedSubCategoryName]];
    updatePlaylist();
    jumpToProblem(0);
}
function updatePlaylist() {
    playlistElem.innerHTML = '';
    currentPracticeSet.forEach((problem, index) => {
        const li = document.createElement('li');
        li.textContent = problem.fr;
        li.dataset.index = index;
        li.addEventListener('click', () => jumpToProblem(index));
        playlistElem.appendChild(li);
    });
    new Sortable(playlistElem, {
        animation: 150,
        ghostClass: 'sortable-ghost',
        onEnd: (evt) => {
            const movedItem = currentPracticeSet.splice(evt.oldIndex, 1)[0];
            currentPracticeSet.splice(evt.newIndex, 0, movedItem);
            Array.from(playlistElem.children).forEach((item, index) => item.dataset.index = index);
            currentIndex = currentPracticeSet.findIndex(p => p.fr === frenchTextElem.textContent);
            highlightCurrentProblem();
        }
    });
}
function highlightCurrentProblem() {
    playlistElem.querySelectorAll('li').forEach(item => item.classList.remove('active'));
    const activeItem = playlistElem.querySelector(`li[data-index="${currentIndex}"]`);
    if (activeItem) {
        activeItem.classList.add('active');
        activeItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
}
function jumpToProblem(index) {
    if (index < 0 || index >= currentPracticeSet.length) {
        currentIndex = 0; // Reset if index is out of bounds
    } else {
        currentIndex = index;
    }
    const problem = currentPracticeSet[currentIndex];
    frenchTextElem.textContent = problem.fr;
    koreanTextElem.textContent = problem.ko;
    if (audioUrl) URL.revokeObjectURL(audioUrl);
    playbackBtn.classList.add('hidden');
    playbackBtn.disabled = true;
    resetResult();
    highlightCurrentProblem();
}
function loadNextProblem() {
    const nextIndex = (currentIndex + 1) % currentPracticeSet.length;
    jumpToProblem(nextIndex);
}
function resetResult() {
    resultArea.firstElementChild.textContent = "마이크 버튼을 누르고 따라 말해보세요.";
    userSaidElem.textContent = "";
    userSaidElem.className = "";
}

recognition.onresult = (event) => {
    const transcript = event.results[0][0].transcript;
    userSaidElem.textContent = `🗣️ "${transcript}"`;
    const originalText = frenchTextElem.textContent.toLowerCase().replace(/[?.,!]/g, '').trim();
    const recognizedText = transcript.toLowerCase().replace(/[?.,!]/g, '').trim();
    if (originalText === recognizedText) {
        userSaidElem.className = 'correct';
        resultArea.firstElementChild.textContent = "🎉 정확해요! 훌륭합니다!";
    } else {
        userSaidElem.className = 'incorrect';
        resultArea.firstElementChild.textContent = "🤔 아쉬워요! 다시 시도해보세요.";
    }
};
recognition.onerror = (event) => {
    if (event.error !== 'aborted') {
      if (event.error == 'no-speech') {
          resultArea.firstElementChild.textContent = "음성을 인식하지 못했어요.";
      } else {
          resultArea.firstElementChild.textContent = "에러: " + event.error;
      }
    }
};
function setupVisualizer() {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
    analyser = audioContext.createAnalyser();
    source = audioContext.createMediaStreamSource(userStream);
    source.connect(analyser);
    analyser.fftSize = 256;
    const bufferLength = analyser.frequencyBinCount;
    dataArray = new Uint8Array(bufferLength);
    drawVisualizer();
}
function drawVisualizer() {
    animationFrameId = requestAnimationFrame(drawVisualizer);
    analyser.getByteFrequencyData(dataArray);
    const canvasCtx = visualizerCanvas.getContext('2d');
    const WIDTH = visualizerCanvas.width;
    const HEIGHT = visualizerCanvas.height;
    canvasCtx.fillStyle = '#f8f9fa';
    canvasCtx.fillRect(0, 0, WIDTH, HEIGHT);
    const barWidth = (WIDTH / dataArray.length) * 2.5;
    let barHeight, x = 0;
    for (let i = 0; i < dataArray.length; i++) {
        barHeight = dataArray[i] / 2.5;
        const blue = barHeight + (25 * (i/dataArray.length));
        const green = 250 * (i/dataArray.length);
        const red = 50;
        canvasCtx.fillStyle = `rgb(${red}, ${green}, ${blue})`;
        canvasCtx.fillRect(x, HEIGHT - barHeight, barWidth, barHeight);
        x += barWidth + 1;
    }
}
</script>
</body>
</html>