<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Le Bon Son - Pro (Final)</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@400;600;700&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <style>
        :root {
            --primary-color: #34568B; /* Sophisticated Blue */
            --secondary-color: #f1c40f; /* Accent Gold */
            --background-color: #f7f9fc;
            --card-background: #ffffff;
            --text-color: #34495e;
            --heading-color: #2c3e50;
            --light-gray: #ecf0f1;
            --success-color: #27ae60;
            --error-color: #c0392b;
            --speak-color: #e67e22;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Nunito Sans', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            overflow: hidden; /* Prevent body scroll */
        }
        .app-container {
            display: flex;
            width: 100%;
            height: 100vh;
        }

        /* --- Main Content --- */
        .main-content {
            flex-grow: 1;
            padding: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow-y: auto;
        }
        .container {
            width: 100%;
            max-width: 600px;
            text-align: center;
        }
        h1 {
            font-family: 'Poppins', sans-serif;
            font-size: 2.2em;
            color: var(--heading-color);
            margin-bottom: 20px;
        }
        .selectors { display: flex; gap: 15px; margin-bottom: 20px; }
        .selectors select {
            flex-grow: 1;
            padding: 12px 15px;
            font-size: 1em;
            border-radius: 10px;
            border: 2px solid var(--light-gray);
            background-color: #fff;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%2334568B%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 15px top 50%;
            background-size: 10px;
            cursor: pointer;
        }
        #sub-category-selector { display: none; }
        #practiceCard {
            padding: 30px; border-radius: 15px; margin-bottom: 20px;
            background-color: var(--card-background); box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
            min-height: 180px; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
        }
        #frenchText {
            font-family: 'Poppins', sans-serif;
            font-size: 3em; color: var(--primary-color);
            margin-bottom: 8px;
        }
        #koreanText { font-size: 1.2em; font-weight: 600; }
        .controls {
            display: grid; grid-template-columns: repeat(4, 1fr);
            gap: 15px; margin-bottom: 20px;
        }
        .controls button {
            width: 70px; height: 70px; font-size: 1.8em;
            border-radius: 50%; border: none; cursor: pointer;
            color: white; transition: all 0.3s ease;
            display: flex; justify-content: center; align-items: center;
            margin: 0 auto;
        }
        .controls button:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.15);
        }
        .controls button:disabled {
            opacity: 0.4; cursor: not-allowed;
            transform: none; box-shadow: none;
        }
        #listenBtn { background-color: var(--primary-color); }
        #speakBtn { background-color: var(--speak-color); }
        #playbackBtn { background-color: #8e44ad; }
        #nextBtn { background-color: var(--success-color); }
        #speakBtn.recording { background-color: var(--error-color); animation: pulse 1.5s infinite; }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(192, 57, 43, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(192, 57, 43, 0); }
            100% { box-shadow: 0 0 0 0 rgba(192, 57, 43, 0); }
        }
        #resultArea {
            min-height: 60px; padding: 15px 20px; border-radius: 12px;
            background-color: var(--card-background); box-shadow: 0 4px 15px rgba(0,0,0,0.06);
        }
        #visualizer {
            width: 100%; height: 50px; background-color: #f8f9fa;
            border-radius: 8px; margin-top: 15px;
        }

        /* --- Sidebar --- */
        .sidebar {
            width: 350px; flex-shrink: 0; background-color: var(--card-background);
            border-left: 1px solid var(--light-gray); padding: 25px;
            display: flex; flex-direction: column; overflow-y: auto;
        }
        .sidebar h2 {
            font-family: 'Poppins', sans-serif; font-size: 1.5em;
            color: var(--heading-color); margin-bottom: 20px;
            text-align: center;
        }
        #playlist { list-style: none; padding: 0; margin: 0; }
        #playlist li {
            padding: 15px; border-bottom: 1px solid var(--light-gray);
            cursor: grab; transition: background-color 0.2s ease;
            font-size: 1.1em; text-align: left;
        }
        #playlist li:hover { background-color: #f0f4f8; }
        #playlist li.active {
            background-color: var(--primary-color); color: white;
            font-weight: 700; border-radius: 8px;
        }
        #playlist li.sortable-ghost { background: #e0eaff; opacity: 0.7; }

        /* --- Responsive --- */
        @media (max-width: 1024px) {
            .sidebar {
                position: fixed; right: 0; top: 0; height: 100%;
                transform: translateX(100%); transition: transform 0.3s ease-in-out;
                z-index: 1000; box-shadow: -10px 0 30px rgba(0,0,0,0.1);
            }
            /* Sidebar toggle functionality would require a toggle button and a bit more JS */
        }
        @media (max-width: 768px) {
            .main-content { padding: 20px; }
            h1 { font-size: 1.8em; }
            #frenchText { font-size: 2.2em; }
            .controls { gap: 10px; }
            .controls button { width: 60px; height: 60px; font-size: 1.5em; }
        }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="app-container">
        <main class="main-content">
            <div class="container">
                <h1>Le Bon Son <span>Pro</span></h1>
                <div class="selectors">
                  <select id="category-selector"></select>
                  <select id="sub-category-selector"></select>
                </div>
                <div id="practiceCard">
                    <h2 id="frenchText"></h2>
                    <p id="koreanText"></p>
                </div>
                <div class="controls">
                    <button id="listenBtn" title="원어민 발음 듣기"><i class="fas fa-volume-up"></i></button>
                    <button id="speakBtn" title="따라 말하기"><i class="fas fa-microphone"></i></button>
                    <button id="playbackBtn" title="내 목소리 듣기" class="hidden" disabled><i class="fas fa-play"></i></button>
                    <button id="nextBtn" title="다음 문제"><i class="fas fa-arrow-right"></i></button>
                </div>
                <div id="resultArea">
                    <p>학습을 시작하세요!</p>
                    <p id="userSaid"></p>
                    <canvas id="visualizer"></canvas>
                </div>
            </div>
        </main>
        <aside class="sidebar">
            <h2><i class="fas fa-list-ul"></i> 학습 목록</h2>
            <ul id="playlist"></ul>
        </aside>
    </div>
    <audio id="playbackAudio" class="hidden"></audio>

<script>
// --- DOM Elements ---
const frenchTextElem = document.getElementById('frenchText');
const koreanTextElem = document.getElementById('koreanText');
const categorySelector = document.getElementById('category-selector');
const subCategorySelector = document.getElementById('sub-category-selector');
const listenBtn = document.getElementById('listenBtn');
const speakBtn = document.getElementById('speakBtn');
const playbackBtn = document.getElementById('playbackBtn');
const nextBtn = document.getElementById('nextBtn');
const resultArea = document.getElementById('resultArea');
const userSaidElem = document.getElementById('userSaid');
const playbackAudio = document.getElementById('playbackAudio');
const playlistElem = document.getElementById('playlist');
const visualizerCanvas = document.getElementById('visualizer');

// --- Global State ---
let allData = {}; 
let currentPracticeSet = [];
let currentIndex = -1;

// --- Recording & Audio API State ---
let mediaRecorder, audioChunks = [], audioBlob, audioUrl, userStream;
let audioContext, analyser, source, dataArray, animationFrameId;

// --- Web Speech API Setup ---
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
if (!SpeechRecognition) {
    alert("죄송하지만, 사용하시는 브라우저는 음성 인식을 지원하지 않습니다. PC 또는 안드로이드의 Chrome 브라우저를 사용해주세요.");
}
const recognition = new SpeechRecognition();
recognition.lang = 'fr-FR';
recognition.interimResults = false;

// --- Initial Load ---
window.addEventListener('DOMContentLoaded', async () => {
    try {
        const response = await fetch('data.json');
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        allData = await response.json();
        populateCategories();
        loadCategory(); 
    } catch (error) {
        console.error('Data loading failed:', error);
        frenchTextElem.textContent = "데이터 로딩 실패";
        koreanTextElem.textContent = "data.json 파일을 확인해주세요.";
    }
});

// --- Category & Playlist Logic ---
function populateCategories() {
    categorySelector.innerHTML = Object.keys(allData).map(name => `<option value="${name}">${name}</option>`).join('');
}
function loadCategory() {
    const selectedCategoryName = categorySelector.value;
    const selectedCategoryData = allData[selectedCategoryName];
    if (Array.isArray(selectedCategoryData)) {
        subCategorySelector.style.display = 'none';
        currentPracticeSet = [...selectedCategoryData]; // Create a mutable copy
        updatePlaylist();
        jumpToProblem(0);
    } else {
        populateSubCategories(selectedCategoryData);
        loadSubCategory();
    }
}
function populateSubCategories(subCategoryData) {
    subCategorySelector.innerHTML = Object.keys(subCategoryData).map(name => `<option value="${name}">${name}</option>`).join('');
    subCategorySelector.style.display = 'block';
}
function loadSubCategory() {
    const selectedCategoryName = categorySelector.value;
    const selectedSubCategoryName = subCategorySelector.value;
    currentPracticeSet = [...allData[selectedCategoryName][selectedSubCategoryName]];
    updatePlaylist();
    jumpToProblem(0);
}
function updatePlaylist() {
    playlistElem.innerHTML = '';
    currentPracticeSet.forEach((problem, index) => {
        const li = document.createElement('li');
        li.textContent = problem.fr;
        li.dataset.index = index;
        li.addEventListener('click', () => jumpToProblem(index));
        playlistElem.appendChild(li);
    });
    new Sortable(playlistElem, {
        animation: 150,
        ghostClass: 'sortable-ghost',
        onEnd: (evt) => {
            const movedItem = currentPracticeSet.splice(evt.oldIndex, 1)[0];
            currentPracticeSet.splice(evt.newIndex, 0, movedItem);
            Array.from(playlistElem.children).forEach((item, index) => item.dataset.index = index);
            currentIndex = currentPracticeSet.findIndex(p => p.fr === frenchTextElem.textContent);
            highlightCurrentProblem();
        }
    });
}
function highlightCurrentProblem() {
    playlistElem.querySelectorAll('li').forEach(item => item.classList.remove('active'));
    const activeItem = playlistElem.querySelector(`li[data-index="${currentIndex}"]`);
    if (activeItem) {
        activeItem.classList.add('active');
        activeItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
}

// --- Problem Navigation ---
function jumpToProblem(index) {
    if (index < 0 || index >= currentPracticeSet.length) return;
    currentIndex = index;
    const problem = currentPracticeSet[currentIndex];
    frenchTextElem.textContent = problem.fr;
    koreanTextElem.textContent = problem.ko;
    if (audioUrl) URL.revokeObjectURL(audioUrl);
    playbackBtn.classList.add('hidden');
    playbackBtn.disabled = true;
    resetResult();
    highlightCurrentProblem();
}
function loadNextProblem() {
    const nextIndex = (currentIndex + 1) % currentPracticeSet.length;
    jumpToProblem(nextIndex);
}
function resetResult() {
    resultArea.firstElementChild.textContent = "마이크 버튼을 누르고 따라 말해보세요.";
    userSaidElem.textContent = "";
    userSaidElem.className = "";
}

// --- Event Listeners ---
categorySelector.addEventListener('change', loadCategory);
subCategorySelector.addEventListener('change', loadSubCategory);
nextBtn.addEventListener('click', loadNextProblem);
listenBtn.addEventListener('click', () => {
    if (!frenchTextElem.textContent || synth.speaking) return;
    const utterThis = new SpeechSynthesisUtterance(frenchTextElem.textContent);
    utterThis.lang = 'fr-FR';
    utterThis.rate = 0.85;
    synth.speak(utterThis);
});
playbackBtn.addEventListener('click', () => playbackAudio.play());

// --- Main Recording & Recognition Logic ---
speakBtn.addEventListener('click', async () => {
    if (!frenchTextElem.textContent) return;
    try {
        userStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        speakBtn.classList.add('recording');
        speakBtn.disabled = true;
        playbackBtn.classList.add('hidden');
        playbackBtn.disabled = true;

        setupVisualizer(); // Start Visualizer
        
        audioChunks = [];
        mediaRecorder = new MediaRecorder(userStream);
        mediaRecorder.addEventListener("dataavailable", e => audioChunks.push(e.data));
        mediaRecorder.addEventListener("stop", () => {
            audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
            audioUrl = URL.createObjectURL(audioBlob);
            playbackAudio.src = audioUrl;
            playbackBtn.classList.remove('hidden');
            playbackBtn.disabled = false;
            userStream.getTracks().forEach(track => track.stop());
        });
        mediaRecorder.start();
        recognition.start();
    } catch (err) {
        console.error("Microphone access error:", err);
        alert("마이크 사용 권한이 필요합니다. 브라우저 설정을 확인해주세요.");
        speakBtn.classList.remove('recording');
        speakBtn.disabled = false;
    }
});
recognition.onend = () => {
    if (mediaRecorder && mediaRecorder.state === "recording") mediaRecorder.stop();
    if (animationFrameId) cancelAnimationFrame(animationFrameId);
    if (audioContext && audioContext.state !== 'closed') audioContext.close();
    speakBtn.classList.remove('recording');
    speakBtn.disabled = false;
};
recognition.onresult = (event) => {
    const transcript = event.results[0][0].transcript;
    userSaidElem.textContent = `🗣️ "${transcript}"`;
    const originalText = frenchTextElem.textContent.toLowerCase().replace(/[?.,!]/g, '').trim();
    const recognizedText = transcript.toLowerCase().replace(/[?.,!]/g, '').trim();
    if (originalText === recognizedText) {
        userSaidElem.className = 'correct';
        resultArea.firstElementChild.textContent = "🎉 정확해요! 훌륭합니다!";
    } else {
        userSaidElem.className = 'incorrect';
        resultArea.firstElementChild.textContent = "🤔 아쉬워요! 다시 시도해보세요.";
    }
};
recognition.onerror = (event) => {
    if (event.error == 'no-speech') {
        resultArea.firstElementChild.textContent = "음성을 인식하지 못했어요. 다시 시도해주세요.";
    } else {
        resultArea.firstElementChild.textContent = "에러: " + event.error;
    }
};

// --- Audio Visualizer Logic ---
function setupVisualizer() {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
    analyser = audioContext.createAnalyser();
    source = audioContext.createMediaStreamSource(userStream);
    source.connect(analyser);
    analyser.fftSize = 256;
    const bufferLength = analyser.frequencyBinCount;
    dataArray = new Uint8Array(bufferLength);
    drawVisualizer();
}
function drawVisualizer() {
    animationFrameId = requestAnimationFrame(drawVisualizer);
    analyser.getByteFrequencyData(dataArray);
    const canvasCtx = visualizerCanvas.getContext('2d');
    const WIDTH = visualizerCanvas.width;
    const HEIGHT = visualizerCanvas.height;
    canvasCtx.fillStyle = '#f8f9fa';
    canvasCtx.fillRect(0, 0, WIDTH, HEIGHT);
    const barWidth = (WIDTH / dataArray.length) * 2.5;
    let barHeight, x = 0;
    for (let i = 0; i < dataArray.length; i++) {
        barHeight = dataArray[i] / 2.5;
        const blue = barHeight + (25 * (i/dataArray.length));
        const green = 250 * (i/dataArray.length);
        const red = 50;
        canvasCtx.fillStyle = `rgb(${red}, ${green}, ${blue})`;
        canvasCtx.fillRect(x, HEIGHT - barHeight, barWidth, barHeight);
        x += barWidth + 1;
    }
}
</script>
</body>
</html>